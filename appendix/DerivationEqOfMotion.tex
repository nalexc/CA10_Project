\chapter{Derivation of the satellite equations of motion} \label{chap:C}
\textit{This section describes the derivation of the mathematical model of the satellite which contains the dynamic and kinematic model, based on the rigid body dynamics and kinematics.}
\subsection{Kinematic equation}
In this subsection, the focus will be on describing the orientation of the satellite. The method used for describing the satellite attitude is quaternion representation. It was decided to choose quaternion representation, because they provide a way to deal with singularities.
\nomenclature[S]{$\vec N_{ext}$}{Represent all the external torques that influence the satellite}
\nomenclature[S]{${\vec{ h_{sat}}}$}{Angular momentum of the satellite}
\nomenclature[S]{${\vec{ h_{tot}}}$}{Total angular momentum}
\nomenclature[S]{$\vec{ \bar{q}}$}{ The operating point}
\nomenclature[S]{$\vec{q_{\omega}}$}{ The angular velocity quaternion}

The quaternion $\textbf{q}(t)$ is defined as the attitude quaternion of a rigid body at time $t$ with respect to the inertial frame and at time $t+\Delta t$, the quaternion $\textbf{q}(t+\Delta t)$ is defined. The orientation quaternion can be divided into the quaternion at time $t$ and performing a quaternion multiplication with the rotation in the interval $\Delta t$ as follows:
\begin{flalign}
	\vec{ ^s_iq}(t+\Delta{t}) = \vec{ q}(\Delta {t}) \otimes \vec{ ^s_i q}(t) 
	\label{eq:qp}
\end{flalign}
where the orientation quaternion $	\vec{ ^s_iq}(t+\Delta{t}) $ represents the rotation of the spacecraft body frame with respect to the inertial frame

The quaternion at time $\Delta t$ can be express using the triad $u, v, w$, that represent the axis of the spacecraft as:
%
\begin{flalign}
	q_{1}(\Delta {t})  = {e_{u}\sin\frac{\Delta\Phi}{2}}
	\label{eq:q11}
\end{flalign}
%
\begin{flalign}
	q_{2}(\Delta {t}) = {e_{v}\sin\frac{\Delta\Phi}{2}}
	\label{eq:q2}
\end{flalign}
%
\begin{flalign}
	q_{3} (\Delta {t})= {e_{w}\sin\frac{\Delta\Phi}{2}}
	\label{eq:q3}
\end{flalign}
%
\begin{flalign}
	q_{4}(\Delta {t}) = {\cos\frac{\Delta\Phi}{2}}
	\label{eq:q4}
\end{flalign}
where $\Delta \Phi$ is the rotation at time $\Delta t$ and $e_u,e_v, e_w$ are the components along the triad $u, v, w$ at time $\Delta t$.

Using equation \ref{eq:q11} and equation \ref{eq:q4} and insert them into equation \ref{eq:qp} which yields:
\begin{flalign}
	\vec{ ^s_i q}(t+\Delta{t})
	= 
	\left\{\cos\frac{\Delta\Phi}{2} \underline I_{(4\times4)}+\sin\frac{\Delta\Phi}{2}
	\begin{bmatrix}
		0 &e_{z}&-e_{y}&e_{x} \\
		-e_{z}&0&e_{x}&e_{y}  \\ 
		e_{y}&-e_{x}&0&e_{z} \\
		-e_{x} &e_{y}&-e_{z}&0
	\end{bmatrix} 
	\right \} \vec{ ^s_i q}(t)
	\label{eq:quatm}
\end{flalign}  
%
where $\underline I$ is the identity matrix with the dimensions of $4\times4$.

In order to turn equation \ref{eq:quatm} into a differential equation, a small angle approximation it is used: 
\begin{flalign}
	&\Delta \phi = \omega \ \Delta t \\
	&\cos\frac{\Delta\Phi}{2} \approx 1 \\	
	&\sin\frac{\Delta\Phi}{2} \approx \frac{\omega \Delta t }{2} \\
	\label{eq:aprox}
\end{flalign} 
After using the approximation and substitute the terms into \ref{eq:quatm}, the following equation is obtained:
\begin{flalign}
	\vec{^s_i q(t+\Delta{t})} \approx \left[1 + \frac{1}{2} \underline \Omega \Delta(t)\right]\vec{^s_i q(t)}
	\label{eq:quatfinal}
\end{flalign} 
where $\underline \Omega$ is the skew symmetric matrix written in form:
\begin{flalign}
	\underline \Omega
	= 
	\begin{bmatrix}
		0& \omega_{w}& - \omega_{v}& \omega_{u} \\
		-\omega_{w}& 0&\omega_{u}& \omega_{v}  \\ 
		\omega_{v}& -\omega_{u}&0& \omega_{w} \\
		-\omega_{u}& -\omega_{v}& -\omega_{w}&0
	\end{bmatrix} 
	\label{eq:sm}
\end{flalign}
where the terms $\omega_u, \omega_v, \omega_w$ are the angular velocities components.

The rate of change in the orientation of the spacecraft $\vec{^s_i q(t)}$  can be found:
\begin{flalign}
	\vec{ ^s_i\dot q(t)} = \lim_{\Delta t\to 0} \frac{\vec q(t+\Delta t) - \vec q(t)}{\Delta t} = \dfrac{1}{2} \underline \Omega \  \vec{^s_i q(t)}
	\label{eq:finaleq}
\end{flalign} 

\subsection{ Dynamic equation}
The satellite dynamics are described using Euler's equation of motion and Newton's laws of motion. 
Using Euler's equation of motion, the relation between the change in angular momentum and the torques that affect the satellite is given as follows:
\begin{flalign}
	\vec{ \dot h} = \vec{N_{ext}} =  \vec{N_{mt}}+ \vec{N_{dist}}
	\label{eq:ec2}
\end{flalign} 
where $h$ is the angular momentum of a rigid body, $N_{ext}$ represent all the external torques that influence the satellite, $N_{mt}$ is the torque from the magnetorquers and $N_{dist}$ is the torque from the disturbances.

The change in angular momentum of the satellite can be express as the product between the angular acceleration and the moment of inertia:
\begin{flalign}
	{\vec{\dot h_{sat}}} = {\underline I_{s}}{\vec{\dot \omega}}
	\label{eq:ec3}
\end{flalign} 
where $h_{sat}$ is the angular momentum of the satellite, $\underline I_{s}$ is the moment of inertia of the satellite and $\vec{\omega}$ is the angular velocity.

Including the momentum wheels, the total angular momentum is given by:
\begin{flalign}
	{\vec{h_{tot}}} = \vec{h_{sat}} + \vec{h_{rw}}
	\label{eq:ec4}
\end{flalign} 
where $\vec{h_{rw}}$ is the angular momentum of the reaction wheels.
Therefore, the total angular momentum is described by:
\begin{flalign}
	{\vec{h_{tot}}} = {\underline I_{s}}{\vec{\omega}}+{\vec{h_{rw}}}
	\label{eq:ec5}
\end{flalign}
By rearranging terms, equation \ref{eq:ec5} becomes:
\begin{flalign}
	{\vec{\omega}} = {\underline I_{s}^{-1}} ({\vec{h_{tot}}}-{\vec{h_{rw}}})
	\label{eq:ec6}
\end{flalign}

Using Euler's equation of motion, the time derivative of $\vec{h_{tot}}$ expressed in the SBRF frame is:
\begin{flalign}
	&	\vec{ \dot h_{tot}} = \vec{ \dot h_{sat}} + \vec \omega \times \vec h_{tot}= \vec{  N_{mt}} + \vec{  N_{dist}} \\
	&\underline I_s {\vec{\dot{\omega}}} + \vec {\dot{h}_{rw}}+ \vec \omega \times \vec h_{tot} = \vec{  N_{mt}} + \vec{  N_{dist}} 
	\label{eq:ec7}
\end{flalign}
Subsequently, the angular velocity is separated and expressed as:
\begin{flalign}
	{\vec{\dot{\omega}}} = -\underline I_s ^{-1} \vec \omega \times \vec h_{tot} -\underline I_s ^{-1} \vec {\dot{h}_{rw}} + \underline I_s ^{-1}(\vec{  N_{mt}} + \vec{  N_{dist}}) 
	\label{eq:ec8}
\end{flalign}
Next, by replacing the cross product with a skew-symmetric matrix ${\underline S(\vec \omega)}$, \eqref{eq:ec8} becomes:
\begin{flalign}&{\vec{\dot{\omega}}}={-\underline I_{s}^{-1}\underline S(\vec \omega)^\times\underline I_{s}\vec \omega-\underline I_{s}^{-1}\underline S(\vec \omega)^\times \vec h_{rw}-\underline I_s ^{-1}\vec{  N_{rw}} + \underline I_s ^{-1}(\vec{  N_{mt}} + \vec{  N_{dist}})}
	\label{eq:ec9}
\end{flalign}
where $N_{mt}$ is the torque from the magnetorquers, $N_{rw}$ is the torque from the momentum wheels and the skew-symmetric matrix is:
\begin{flalign}
	{\underline S(\vec \omega)^\times}
	\overset{\Delta}{=}
	\begin{bmatrix}
		0& -\omega_{3}& \omega_{2} \\
		\omega_{3}& 0&-\omega_{1}  \\ 
		-\omega_{2} & \omega_{1} &0
	\end{bmatrix} 
	\label{eq:skewsymmetricmatrix}
\end{flalign}
Moreover, the torque set to the momentum wheels is equal to the time derivative of the angular momentum:
\begin{flalign}
	\vec {N_{rw}} =  {\vec{ \dot{h}_{rw}}}
	\label{eq:ec10}
\end{flalign}
\subsection{Linearization of satellite  equations}
Due to the non-linear equations of motion of the satellite derived in the above sections, a linearization of these equations around an operating point is made, which will serve for designing a linear controller. 
\subsubsection{Kinematic  equation}
Starting with the non-linear kinematic equation which is given by:
\begin{flalign}
	\vec{ \dot q(t)} = \dfrac{1}{2} \underline \Omega   \vec{ q(t)}
	\label{eq:lke}
\end{flalign} 
Consequently, the quaternion can be expressed in a different form by dividing the initial quaternion $\vec{ q(t)} $ into a quaternion that represents the operating point and a quaternion error which represent a variation around the operating point:
\begin{flalign}
	\vec{ q}(t+\Delta{t}) = \vec{ q}(\Delta {t}) \otimes \vec{ q}(t) = \vec{ \bar{q}} \otimes \vec{\tilde{q}} 
	\label{eq:qpf}
\end{flalign}
where, \\
$\vec{ \bar{q}}$ is the operating point \\
$\vec{ \tilde{q}}$ is the quaternion error

By applying quaternion properties, the quaternion error can be written as:
\begin{flalign}
   \vec{\tilde{q}} = \vec{  \bar{q}}^{-1} \otimes \vec{ q} = \vec{  \bar{q}}^{\ast} \otimes \vec{ q}
	\label{eq:smallsignal}
\end{flalign}
where $ \vec{ {q}}^{-1} = \vec{q^{\ast}}$

Equation \ref{eq:lke} can be expanded by using a two quaternion multiplication, where the properties of these multiplication can be seen in appendix \ref{chap:B}, therefore equation \ref{eq:lke} becomes:
\begin{flalign}
\vec{ \dot q} = \dfrac{1}{2}  \vec{q} \otimes  \vec{q_{\omega}}
\label{eq:lkfe}
\end{flalign}
where $\vec{q_{\omega}}$ is the angular velocity quaternion and is given by: $\vec{q_{\omega}} = \vec{  \bar{q}} + \vec{  \tilde{q}}$

Taking the time derivative of equation \ref{eq:smallsignal} and using the product rule, the equation becomes:
\begin{flalign}
	\vec{\dot {\tilde{ q}}} = \vec{ \dot { \bar{q}}^{\ast}} \otimes \vec{ q} + \vec{   \bar{q}^{\ast}} \otimes \vec{\dot q}
	\label{eq:smallsignalr}
\end{flalign}
Inserting equation \ref{eq:lkfe} into equation \ref{eq:smallsignalr} and using the following properties of quaternions $\vec{q^{\ast}_{\omega}} = -\vec{q_{\omega}}$ and $(\vec q \vec{q_{\omega}}^{\ast}) = \vec{q^{\ast}_{\omega}} \vec{q^{\ast}} $, the equation \ref{eq:lkfe} result in:
\begin{flalign}
\vec{\dot {\tilde{ q}}} = \dfrac{1}{2} \Big [- \vec{\bar q_{\omega}} \otimes \vec{\tilde{q}} + \vec{\tilde{q}} \otimes \vec{\bar q_{\omega}} + \vec{\tilde q} \otimes \vec{\tilde q_{\omega}} \Big ]
\label{eq:smallsignfalr}
\end{flalign}
In order to express the products quaternion from the previous equation, the product of these quaternion can be written as a matrix that have the real and the complex part and one quaternion, which will end up as a product between a matrix and a vector. Therefore, the product quaternion between $\vec{\bar q_{\omega}} \otimes \vec{\tilde{q}} $ can be rewritten as:
\begin{flalign}   
\vec{\bar q_{\omega}} \otimes \vec{\tilde{q}}  
= 
\begin{bmatrix}
& - \underline S(\vec{\tilde q})^\times + \underline{\vec 1} {\tilde q_4} & \vec{\tilde q} \\
& - \vec{\tilde q}^\mathsf{T}& {\tilde q_4}  \\ 
\end{bmatrix} 
\begin{bmatrix}
&   \vec{\bar \omega} \\
& 0 \\ 
\end{bmatrix} 
=
\begin{bmatrix}
& - \underline S(\vec{\bar \omega})^\times \vec{\tilde q} + \underline{\vec 1} {\tilde q_4} \vec{\bar \omega}  \\
& - \vec{\tilde q}^\mathsf{T} \vec{\bar \omega}\\ 
\end{bmatrix} 
\label{eq:sffm}
\end{flalign}
where the following property is used $\underline S(\vec{\bar \omega})^\times \vec{\tilde q} = - \underline S(\vec{\tilde q} )^\times \vec{\bar \omega} $ and $ S(\vec \omega)^\times$ is the skew symmetric matrix.

Similarly, the product quaternion between $ \vec{\tilde{q}} \otimes \vec{\bar q_{\omega}}  $ is found:
\begin{flalign}   
\vec{\tilde{q}} \otimes \vec{\bar q_{\omega}}  
= 
\begin{bmatrix}
& - \underline S(\vec{\bar \omega}^\times & \vec{\bar \omega}\\
& - \vec{\bar \omega}^\mathsf{T}& 0  \\ 
\end{bmatrix} 
\begin{bmatrix}
&  \vec{\tilde{q}} \\
&  {\tilde q_4}\\ 
\end{bmatrix} 
=
\begin{bmatrix}
& - \underline S(\vec{\bar \omega})^\times \vec{\tilde q} +  \vec{\bar \omega} {\tilde q_4}   \\
& - \vec{\tilde \omega}^\mathsf{T} \vec{\tilde q}\\ 
\end{bmatrix} 
\label{eq:sfm}
\end{flalign}
The last product quaternion can be found in the same manner:
\begin{flalign}   
	\vec{\tilde{q}} \otimes \vec{\tilde q_{\omega}}  
	= 
	\begin{bmatrix}
		& - \underline S(\vec{\tilde \omega})^\times & \vec{\tilde \omega}\\
		& - \vec{\tilde \omega}^\mathsf{T}& 0  \\ 
	\end{bmatrix} 
	\begin{bmatrix}
		&  \vec{\tilde{q}} \\
		&  {\tilde q_4}\\ 
	\end{bmatrix} 
	=
	\begin{bmatrix}
		& - \underline S(\vec{\tilde \omega})^\times \vec{\tilde q} +  \vec{\tilde \omega} {\tilde q_4}   \\
		& - \vec{\tilde \omega}^\mathsf{T} \vec{\tilde q}\\ 
	\end{bmatrix} 
	\label{eq:sfgfm}
\end{flalign}
Using the following property, a small approximation for the angle is made %Satellite Attitude Control Using Only Electromagnetic Actuation/ rafal%:
\begin{equation}
	  \lim_{\theta \to 0} \vec q = 	  \lim_{\theta \to 0} 
	 \left[ 
	 \begin{array}{cccc}
	 	\vec q \\
	 	q_4 
	 \end{array}
	 \right] 
	 =  \lim_{\theta \to 0} 
	 \left[ 
	 \begin{array}{cccc}
	    e_u \sin (\tfrac{\theta}{2}) \\
	 	e_v \sin (\tfrac{\theta}{2}) \\
	 	e_w \sin (\tfrac{\theta}{2}) \\
	 	\cos (\tfrac{\theta}{2}) 
	 \end{array}
	 \right] 
\end{equation}
where $\vec{\tilde q} \rightarrow $ 0 and $\tilde q_4 \rightarrow $ 1

Therefore, equation \ref{eq:sfgfm} can be rewritten by using this property as:
\begin{flalign}   
	\vec{\tilde{q}} \otimes \vec{\tilde q_{\omega}}  
	=
	\begin{bmatrix}
		& - \underline S(\vec{\tilde \omega})^\times \vec{\tilde q} +  \vec{\tilde \omega} {\tilde q_4}   \\
		& - \vec{\tilde \omega}^\mathsf{T} \vec{\tilde q}\\ 
	\end{bmatrix} 
=
\vec{\tilde q_{\omega}}  
	\label{eq:sfgffm}
\end{flalign}
Collecting terms and inserting equation \ref{eq:sffm},  \ref{eq:sfm}, \ref{eq:sfgffm} into equation  \ref{eq:smallsignfalr} yields the following form:
\begin{flalign}
	\vec{\dot {\tilde{ q}}} \approx  
	- \frac{1}{2}
	\begin{bmatrix}
		- \underline S(\vec{\bar \omega})^\times \vec{\tilde q} + \underline{\vec 1} {\tilde q_4} \vec{\bar \omega}  \\
		- \vec{\tilde q}^\mathsf{T} \vec{\bar \omega}\\ 
	\end{bmatrix} 
+ \frac{1}{2}
\begin{bmatrix}
	- \underline S(\vec{\bar \omega})^\times \vec{\tilde q} +  \vec{\bar \omega} {\tilde q_4}   \\
    - \vec{\tilde \omega}^\mathsf{T} \vec{\tilde q}\\ 
\end{bmatrix} 
+\frac{1}{2} \vec{\tilde q_{\omega}} \approx
\begin{bmatrix}
	- \underline S(\vec{\bar \omega})^\times \\
	0\\ 
\end{bmatrix}
\vec{\tilde q} + \frac{1}{2} \vec{\tilde q_{\omega}}
	\label{eq:smallsignffalr}
\end{flalign}
\subsubsection{Dynamic  equation}
Next, the non-linear dynamic equation is given by:
\begin{align*}
	\begin{split}
	{\vec{\dot{\omega}}} &={-\underline I_{s}^{-1}\underline S(\vec \omega)^\times\underline I_{s}\vec \omega-\underline I_{s}^{-1}\underline S(\vec \omega)^\times\vec h_{rw}-\underline I_s ^{-1}\vec{  N_{rw}} + \underline I_s ^{-1}(\vec{  N_{mt}} + \vec{  N_{dist}})} = \\
	&= {\underline I_{s}^{-1}} [\vec{  N_{dist}} + \vec{  N_{ctrl}} - S(\vec \omega)^\times (\underline I_{s}\vec \omega + \vec h_{rw})] 
\label{eq:ec34}
\end{split}
\end{align*}
An operating point is introduce as:
\begin{flalign}
    \vec{\omega} = \vec{\bar{\omega}} + \vec{\tilde{\omega}} 
	\label{eq:smallsi4gnal}
\end{flalign}
where the angular velocity $\vec{\omega}$ is separated into a operating point $\vec{\bar{\omega}}$ and the error around this operating point $\vec{\tilde{\omega}}$.

The next step is to use a a first order Taylor expansion for linearizing the time derivative of the angular velocity, with the mention of neglecting the $ \vec {  N_{dist}}$ which is assumed to be insignificant.
\begin{flalign}
		{\vec{\dot{\omega}}} \approx {-\underline I_{s}^{-1}} \frac{d {\vec{\dot{\omega}}}}{d {\vec{{\omega}}}} \Big|_{{\vec{{\omega}}} = {\vec{{\bar \omega}}}} \vec{{\tilde \omega}} -  {\underline I_{s}^{-1}} \frac{d {\vec{\dot{\omega}}}}{d {\vec{{h_{rw}}}}} \Big|_{{\vec{{h_{rw}}}} = {\vec{{\bar h_{rw}}}}} \vec{{\tilde h_{rw}}} + {\underline I_{s}^{-1}} \frac{d {\vec{\dot{\omega}}}}{d {\vec{{N_{ctrl}}}}} \Big|_{{\vec{{N_{ctrl}}}} = {\vec{{\bar N_{ctrl}}}}} \vec{{\tilde N_{ctrl}}} 
		\label{eq:ec3f4}
\end{flalign}
By using the property $\underline S(\vec \omega)^\times\underline I_{s}\vec{\bar \omega} = - \underline S(\underline I_{s}\vec{\bar \omega})^\times  \vec \omega$ and rewriting the \ref{eq:ec3f4} by expanding the terms, will result the linearized dynamic equation:
\begin{flalign}
{\vec{\dot{\omega}}} = \underline I_{s}[ \underline S(\underline I_{s}\vec{\bar \omega})^\times  - \underline S(\vec{\bar \omega})^\times \underline I_{s} + \underline S(\vec{\bar h_{rw}})^\times ] {\vec{\tilde{\omega}}} - \underline I_{s} \underline S(\vec{\bar \omega})^\times \vec{\tilde h_{rw}} + \underline I_{s}  \vec{\tilde N_{ctrl}}
\label{eq:ec3fr4}
\end{flalign}
