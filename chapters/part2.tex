
\chapter{Attitude control}
\section{Modelling}
This section describes the mathematical model of the satellite which contains the dynamic and kinematic model, based on the rigid body dynamics and kinematics.
\subsection{Spacecraft dynamic equation}
The satellite dynamics are described using Euler's equation of motion and Newton's laws of motion. 
Using Euler's equation of motion, the relation between the change in angular momentum and the torques that affect the satellite is given as follows:
\begin{flalign}
	\vec{ \dot h} = \vec{N_{ext}} =  \vec{N_{mt}}+ \vec{N_{dist}}
	\label{eq:ec2}
\end{flalign} 
where $h$ is the angular momentum of a rigid body, $N_{ext}$ represent all the external torques that influence the satellite, $N_{mt}$ is the torque from the magnetorquers and $N_{dist}$ is the torque from the disturbances.

The change in angular momentum of the satellite can be express as the product between the angular acceleration and the moment of inertia:
\begin{flalign}
	{\vec{\dot h_{sat}}} = {\underline I_{s}}{\vec{\dot \omega}}
	\label{eq:ec3}
\end{flalign} 
where $h_{sat}$ is the angular momentum of the satellite, $\underline I_{s}$ is the moment of inertia of the satellite and $\vec{\omega}$ is the angular velocity.

Including the momentum wheels, the total angular momentum is given by:
\begin{flalign}
	{\vec{h_{tot}}} = \vec{h_{sat}} + \vec{h_{rw}}
	\label{eq:ec4}
\end{flalign} 
where $\vec{h_{mw}}$ is the angular momentum of the momentum wheels.
Therefore, the total angular momentum is described by:
\begin{flalign}
	{\vec{h_{tot}}} = {\underline I_{s}}{\vec{\omega}}+{\vec{h_{rw}}}
	\label{eq:ec5}
\end{flalign}
By rearranging terms, equation \ref{eq:ec5} becomes:
\begin{flalign}
	{\vec{\omega}} = {\underline I_{s}^{-1}} ({\vec{h_{tot}}}-{\vec{h_{rw}}})
	\label{eq:ec6}
\end{flalign}

Using Euler's equation of motion, the time derivative of $\vec{h_{tot}}$ expressed in the ECI frame is:
\begin{flalign}
	&	\vec{ \dot h_{tot}} = \vec{ \dot h_{sat}} + \vec \omega \times \vec h= \vec{  N_{mt}} + \vec{  N_{dist}} \\
	 &\underline I_s {\vec{\dot{\omega}}} + \vec {\dot{h}_{rw}}+ \vec \omega \times \vec L = \vec{  N_{mt}} + \vec{  N_{dist}} 
	 \label{eq:ec7}
 \end{flalign}
Subsequently, the angular velocity is separtated and expressed as:
\begin{flalign}
{\vec{\dot{\omega}}} = -\underline I_s ^{-1} \vec \omega \times \vec L -\underline I_s ^{-1} \vec {\dot{h}_{rw}} + \underline I_s ^{-1}(\vec{  N_{mt}} + \vec{  N_{dist}}) 
\label{eq:ec8}
\end{flalign}
Next, by replacing the cross product with a skew-symmetric matrix ${\underline S(\vec \omega)}$, \eqref{eq:ec8} becomes:
\begin{flalign}&{\vec{\dot{\omega}}}={-\underline I_{s}^{-1}\underline S(\vec \omega)\underline I_{s}\vec \omega-\underline I_{s}^{-1}\underline S(\vec \omega)\vec h_{rw}-\underline I_s ^{-1}\vec{  N_{rw}} + \underline I_s ^{-1}(\vec{  N_{mt}} + \vec{  N_{dist}})}
\label{eq:ec9}
\end{flalign}
where $N_{mt}$ is the torque from the magnetorquers, $N_{rw}$ is the torque from the momentum wheels and the skew-symmetric matrix is:
\begin{flalign}
	{\underline S(\vec \omega)}
	= 
	\begin{bmatrix}
		0& -\omega_{3}& \omega_{2} \\
		\omega_{3}& 0&-\omega_{1}  \\ 
		-\omega_{2} & \omega_{1} &0
	\end{bmatrix} 
	\label{eq:skewsymmetricmatrix}
\end{flalign}
Moreover, the torque set to the momentum wheels is equal to the time derivative of the angular momentum:
\begin{flalign}
    \vec {N_{rw}} =  {\vec{ \dot{h}_{rw}}}
	\label{eq:ec10}
\end{flalign}
\subsection{Spacecraft kinematic equation}
In this subsection, the focus will be on describing the orientation of the satellite. The method used for describing the satellite attitude is quaternion representation. It was decided to choose quaternion representation, because they provide a way to deal with singularities.

The quaternion $\textbf{q}(t)$ is defined as the attitude quaternion of a rigid body at time $t$ with respect to the inertial frame and at time $t+\Delta t$, the quaternion $\textbf{q}(t+\Delta t)$ is defined. The orientation quaternion can be divided into the quaternion at time $t$ and performing a quaternion multiplication with the rotation in the interval $\Delta t$ as follows:
\begin{flalign}
	\vec{ ^s_iq}(t+\Delta{t}) = \vec{ q}(\Delta {t}) \otimes \vec{ ^s_i q}(t) 
	\label{eq:qp}
\end{flalign}
where the orientation quaternion $	\vec{ ^s_iq}(t+\Delta{t}) $ represents the rotation of the spacecraft body frame with respect to the intertial frame

The quaternion at time $\Delta t$ can be express using the triad $u, v, w$, that represent the axis of the spacecraft as:
%
\begin{flalign}
	q_{1}(\Delta {t})  = {e_{u}\sin\frac{\Delta\Phi}{2}}
	\label{eq:q11}
\end{flalign}
%
\begin{flalign}
	q_{2}(\Delta {t}) = {e_{v}\sin\frac{\Delta\Phi}{2}}
	\label{eq:q2}
\end{flalign}
%
\begin{flalign}
	q_{3} (\Delta {t})= {e_{w}\sin\frac{\Delta\Phi}{2}}
	\label{eq:q3}
\end{flalign}
%
\begin{flalign}
	q_{4}(\Delta {t}) = {\cos\frac{\Delta\Phi}{2}}
	\label{eq:q4}
\end{flalign}
where $\Delta \Phi$ is the rotation at time $\Delta t$ and $e_u,e_v, e_w$ are the components along the triad $u, v, w$ at time $\Delta t$.

Using equation \ref{eq:q11} and equation \ref{eq:q4} and insert them into equation \ref{eq:qp} which yields:
\begin{flalign}
	\vec{ ^s_i q}(t+\Delta{t})
	= 
	\left\{\cos\frac{\Delta\Phi}{2} \underline I_{(4\times4)}+\sin\frac{\Delta\Phi}{2}
	\begin{bmatrix}
		0 &e_{z}&-e_{y}&e_{x} \\
		-e_{z}&0&e_{x}&e_{y}  \\ 
		e_{y}&-e_{x}&0&e_{z} \\
		-e_{x} &e_{y}&-e_{z}&0
	\end{bmatrix} 
	\right \} \vec{ ^s_i q}(t)
	\label{eq:quatm}
\end{flalign}  
%
where $\underline I$ is the identity matrix with the dimensions of $4\times4$.

In order to turn equation \ref{eq:quatm} into a differential equation, a small angle approximation it is used: 
\begin{flalign}
	&\Delta \phi = \omega \ \Delta t \\
	&\cos\frac{\Delta\Phi}{2} \approx 1 \\	
	&\sin\frac{\Delta\Phi}{2} \approx \frac{\omega \Delta t }{2} \\
	\label{eq:aprox}
\end{flalign} 
After using the approximation and substitute the terms into \ref{eq:quatm}, the following equation is obtained:
\begin{flalign}
	\vec{^s_i q(t+\Delta{t})} \approx \left[1 + \frac{1}{2} \underline \Omega \Delta(t)\right]\vec{^s_i q(t)}
	\label{eq:quatfinal}
\end{flalign} 
where $\underline \Omega$ is the skew symmetric matrix written in form:
\begin{flalign}
	\underline \Omega
	= 
	\begin{bmatrix}
		0& \omega_{w}& - \omega_{v}& \omega_{u} \\
		-\omega_{w}& 0&\omega_{u}& \omega_{v}  \\ 
		\omega_{v}& -\omega_{u}&0& \omega_{w} \\
		-\omega_{u}& -\omega_{v}& -\omega_{w}&0
	\end{bmatrix} 
	\label{eq:sm}
\end{flalign}
where the terms $\omega_u, \omega_v, \omega_w$ are the angular velocities componets.

The rate of change in the orientation of the spacecraft $\vec{^s_i q(t)}$  can be found:
\begin{flalign}
	\vec{ ^s_i\dot q(t)} = \lim_{\Delta t\to 0} \frac{\vec q(t+\Delta t) - \vec q(t)}{\Delta t} = \dfrac{1}{2} \underline \Omega \  \vec{^s_i q(t)}
	\label{eq:finaleq}
\end{flalign} 
\subsection{Spacecraft equation of motion }
Putting together both dynamic and kinematic equation for the spacecraft, the system equations can be combined into a state-space representation:
\begin{flalign}
	\begin{bmatrix}
		\vec{ ^s_i\dot q(t)} \\
		\vec{\dot \omega{(t)}}
	\end{bmatrix} 	
	= 
	\begin{bmatrix}
		\frac{1}{2} \underline{ \Omega}_{(4\times4)} \vec{ ^s_i q(t)} \\
		{-\underline{I}_{s}^{-1}\underline{S}(\vec{\omega})\underline{I}_{s}\vec{\omega}(t)-\underline{I}_{s}^{-1}\underline{S}(\vec{\omega})\vec{h_{rw}}-\underline{I}_{s}^{-1}\vec{N_{rw}}(t)+\underline{I}_{s}^{-1}[\vec{N_{mt}(t)}+\vec{N_{dis}}(t)}]
	\end{bmatrix} 
	\label{eq:seom}
\end{flalign}
where,\\
$\vec{ ^s_i  q(t)} = [q_1 \ q_2 \ q_3 \ q_4]^T$ \\
$\vec{\omega{(t)}} = [ \omega_1 \ \omega_2 \ \omega_3]^T$ \\
$\underline{\Omega}(\omega)$ is the $4\times4$ skew symmetric matrix \\
$\underline{I}_{s}$ is the inertia matrix \\
$\underline{S}(\omega)$ is the $3\times3$ skew symmetric matrix \\
$\vec{N_{dis}}(t)$ is the disturbance torque \\
$\vec{N_{rw}}$ is the torque from momentum wheels \\
$\vec{N_{mt}}$ is the torque from magnetorquers  \\

\chapter{Magnetorqer model}
% The total disturbance torque can now be derived as.... [for disturbances]
% In SD a short description about how many magnetorqers we use and why
% maybe to put the RW and MT in the SD both with general description and model
% ref for magnetorqer: serway and wartz or "Fully magnetic attitude control for spacecraft subject
%to gravity gradient" Rafal
% m is given in the sat body frame and is needed in control frame so we need a rotation 

Since the primary actuators for the satellite are chosen to be reaction wheels, the magnetorqers will be used for desaturation of the reaction wheels. The satellite contains onboard four magnetorqers mounted perpendicular to each other. 

Having a solenoid onboard of the satellite, referred as a magnetorqer through which the current could be controlled and hence the dipole moment.

The interaction of the dipole with the magnetic field of the Earth will result in a torque that will be perpendicular to the magnetic field vecotor according to the following equation:
\begin{flalign}
   \vec N_{mt} = \vec m \times \vec B
	\label{eq:NT}
\end{flalign} 
where $\vec N$ is the torque produce by the magnetorquer and will be the torque that will influence the satellite dynamics as stated in ref to dynamic eq ?, $\vec B$ is the vector of the magnetic field of the Earth and $\vec m $ is the magnetic dipole moment generated by the magnetorquer.

The magnetic moment $\vec m$ is given by:
\begin{flalign}
	\vec m = n_{coil} \ I_{coil} \ \vec A_{coil}
	\label{eq:mm}
\end{flalign} 
where $n_{coil}$ is the windings of the coil, $I_{coil}$ is the electric current on the coil and $\vec A_{coil}$ is the vector perpendicular to the cross-sectional area of the magnetorquer.

Using \ref{eq:NT} and \ref{eq:mm} and taking the magnitude, the applied torque on the satellite is [serway]:
\begin{flalign}
	\vec N_{mt} = n_{coil} \ \rvert I_{coil}\rvert \ \rvert \vec A_{coil}\rvert \ |\vec B| \sin (\theta)
	\label{eq:ft}
\end{flalign} 
where $\sin (\theta)$ is the angle between the area $A_{coil}$ and the magnetic field vector $\vec B$.

The design of the magnetorquers placed inside the satellie is inspired from (thesis), where to types of magnetorqers are described: one with metal core and without core. The parameters for one magnetorqer without core are presented in table \ref{table:for}:

\begin{table}[H]
	\centering
	\begin{tabular}{|l|l|}
		\hline
		\textit{\textbf{Parameter}}     & \textit{\textbf{Value}}                     				     \\ \hline
		Coil size                       		   & 75x75 {[}$mm^2$ {]}                      					  \\ \hline
		Wire Thickness                      & 0.13 {[}$mm${]}                             					 	\\ \hline
		Windings                        		& 250                                          						     	 \\ \hline
		Coil mass                     		    & 0.053 [$kg$]                                    					    \\ \hline
		Max voltage                  	      & ±1.25 {[}$V${]} (controlled by PWM duty cycle) 		\\ \hline
		Max current                  	      & 15.78 {[}$mA${]}                               						   \\ \hline
		Actuator on time                   & 88\%                                      				                        \\ \hline
		Max power consumption pr. coil  & 17.4 {[}$mW$ {]}                            					     \\ \hline
		Total power consumption     & 134.2 {[}$mW${]}                           	  					   	    \\ \hline
		Coil Discharge time:             & 0.33481 {[}$ms${]} (99\% discharged)   					     \\ \hline
		Available time for measurements & 11.67 {[}$ms${]}                               					     \\ \hline
	\end{tabular}
	\caption{Parameters for magnetorqer without metal core}
		\label{table:for}
\end{table}

For this type of magnetorqer, one magnetorqer will generate around 200 [$nNm$] at low magnetic field strength (18000 [$nT$), which is perpendicular to the area of the coil. (thesis)

A second alternative is to choose a magnetorqer with metal core, because the power consumption, the size and weight are considered superior compared with a magnetorqer without cores. Moreover, because the interest in redundancy is important and four magnetorqers will be placed inside the satellite, the magnetorqer with metal core is preferable because of their weight and size. The parameters for the magnetorqer with metal core is illustrated in the following table:
\begin{table}[H]
	\centering
	\begin{tabular}{|l|l|}
		\hline
		\textit{\textbf{Parameter}}     & \textit{\textbf{Value}}               \\ \hline
		Core diameter:                       & 10 {[}$mm$ {]}                           \\ \hline
		Core length             			   & 10 {[}$mm${]}                             \\ \hline
		Permeability                           & 1000                                      	     \\ \hline
		Wire Thickness                      & 0.13 [$mm$]                                 \\ \hline
		Windings                                & 200 											      \\ \hline
		Coil mass                               & 0.019 {[}$kg${]}                               \\ \hline
		Max voltage                			  & ±1.25 {[}$V${]}                                  \\ \hline
		Max current							  & 20 {[}$mA$ {]}                                    \\ \hline
		External resistance needed   & 62.5 {[}$\Omega$ {]} 					  	 \\ \hline
		Actuator on time			       & 27 \% {[}$mW${]}                                  \\ \hline
		Max power consumption pr. coil     & 6.75{[}$mW${]} 				           \\ \hline
		Total power consumption		& 35.3 {[}$mW${]}                                      \\ \hline
	\end{tabular}
	\caption{Parameters for magnetorqer with metal core}
	\label{table:for1}
\end{table}
In this case, one magnetorqer will generate around 400 [$nNm$] at low magnetic field strength (18000 [$nT$). Besides the advantage of having a reduced dimension and a better power consumption, the magnetorqer with core, generates a magnetic moment higher than expected. On the other hand, the magnetorqer without core was already tested on the AAUSAT and can be seen as a safe choice of actuator.

\section{Magnetic residual }
%ref: Wertz and for B = 2m/r : Space Mission Analysis and Design
When the satellite orbits the Earth, due to the interference of the magnetic field of the Earth and the satellite magnetic residual, an extra disturbance torque is generated. Because the satellite can not be perfectly isolated, the actuators and sensors will produce a residual magnetic moment. Similarly like magnetorqers, the torque generated by the magnetic residual can be computed using:
\begin{flalign}
	\vec N_{mr} = \vec m \times \vec B
	\label{eq:st}
\end{flalign}
where $\vec m$ is the magnetic residual and $\vec B$ is the magnetic field of the Earth.

The magnetic field of the Earth can be approximated using:
\begin{flalign}
	 B = \dfrac{2M}{R^3}
	\label{eq:ftf}
\end{flalign}
where $M$ is the Earth magnetic moment and $R$ is the radius from Earth center to satellite.
